<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>GÃ¶zleme Finder London</title>
<link href="https://fonts.googleapis.com/css2?family=Playfair+Display:ital,wght@0,700;1,400&family=DM+Mono:wght@400;500&family=DM+Sans:wght@300;400;500&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #f5ede0;
    --ink: #1a1008;
    --terracotta: #c9512a;
    --gold: #d4a017;
    --cream: #fdf6ec;
    --smoke: #e8ddd0;
    --accent: #2a6b5c;
    --places-blue: #1a73e8;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    background: var(--bg);
    color: var(--ink);
    font-family: 'DM Sans', sans-serif;
    min-height: 100vh;
    overflow-x: hidden;
  }

  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      radial-gradient(circle at 15% 20%, rgba(201,81,42,0.08) 0%, transparent 40%),
      radial-gradient(circle at 85% 70%, rgba(42,107,92,0.08) 0%, transparent 40%);
    pointer-events: none;
    z-index: 0;
  }

  .container {
    max-width: 920px;
    margin: 0 auto;
    padding: 0 24px;
    position: relative;
    z-index: 1;
  }

  /* Header */
  header { padding: 52px 0 32px; text-align: center; }

  .eyebrow {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.2em;
    text-transform: uppercase;
    color: var(--terracotta);
    margin-bottom: 16px;
  }

  h1 {
    font-family: 'Playfair Display', serif;
    font-size: clamp(44px, 8vw, 76px);
    line-height: 0.95;
    color: var(--ink);
  }

  h1 em { font-style: italic; color: var(--terracotta); }

  .subtitle {
    font-size: 15px;
    color: #6b5a4a;
    font-weight: 300;
    margin-top: 18px;
    max-width: 440px;
    margin-left: auto;
    margin-right: auto;
    line-height: 1.6;
  }

  /* Divider */
  .divider { display: flex; align-items: center; gap: 12px; margin: 28px 0; }
  .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: linear-gradient(to right, transparent, var(--gold)); }
  .divider::after { background: linear-gradient(to left, transparent, var(--gold)); }
  .divider span { font-size: 18px; }

  /* API Key Panel */
  .api-panel {
    background: var(--cream);
    border: 1px solid var(--smoke);
    border-radius: 2px;
    margin-bottom: 16px;
    overflow: hidden;
  }

  .api-panel-toggle {
    width: 100%;
    padding: 14px 20px;
    background: none;
    border: none;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: space-between;
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #8a7060;
  }

  .api-panel-toggle:hover { color: var(--terracotta); }
  .api-panel-toggle .chevron { transition: transform 0.2s; font-size: 10px; }
  .api-panel-toggle.open .chevron { transform: rotate(180deg); }

  .api-panel-body { display: none; padding: 0 20px 20px; border-top: 1px solid var(--smoke); }
  .api-panel-body.open { display: block; }

  .api-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 16px;
    margin-top: 16px;
  }

  @media (max-width: 600px) { .api-grid { grid-template-columns: 1fr; } }

  .api-field label {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.12em;
    text-transform: uppercase;
    color: #8a7060;
    display: block;
    margin-bottom: 6px;
  }

  .api-field input {
    width: 100%;
    padding: 10px 14px;
    border: 1.5px solid var(--smoke);
    border-radius: 2px;
    background: var(--bg);
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }

  .api-field input:focus { border-color: var(--terracotta); }

  .api-hint { font-size: 12px; color: #a08878; margin-top: 6px; line-height: 1.5; }
  .api-hint a { color: var(--terracotta); }

  .api-status { display: flex; gap: 12px; margin-top: 14px; flex-wrap: wrap; }

  .status-pill {
    display: flex;
    align-items: center;
    gap: 6px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 4px 10px;
    border-radius: 20px;
    border: 1px solid var(--smoke);
    color: #8a7060;
  }

  .status-pill .dot { width: 6px; height: 6px; border-radius: 50%; background: var(--smoke); }
  .status-pill.active { color: var(--accent); border-color: rgba(42,107,92,0.3); }
  .status-pill.active .dot { background: var(--accent); }

  /* Search Section */
  .search-section {
    background: var(--cream);
    border: 1px solid var(--smoke);
    border-radius: 2px;
    padding: 28px;
    margin-bottom: 32px;
    box-shadow: 6px 6px 0 rgba(201,81,42,0.1);
  }

  .search-label {
    font-family: 'DM Mono', monospace;
    font-size: 11px;
    letter-spacing: 0.15em;
    text-transform: uppercase;
    color: #8a7060;
    display: block;
    margin-bottom: 10px;
  }

  .search-row { display: flex; gap: 12px; flex-wrap: wrap; }

  .search-input {
    flex: 1;
    min-width: 200px;
    padding: 13px 18px;
    border: 1.5px solid var(--smoke);
    border-radius: 2px;
    background: var(--bg);
    font-family: 'DM Sans', sans-serif;
    font-size: 16px;
    color: var(--ink);
    outline: none;
    transition: border-color 0.2s;
  }

  .search-input:focus { border-color: var(--terracotta); }

  .search-btn {
    padding: 13px 28px;
    background: var(--terracotta);
    color: white;
    border: none;
    border-radius: 2px;
    font-family: 'DM Mono', monospace;
    font-size: 12px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .search-btn:hover { background: #b04422; transform: translateY(-1px); box-shadow: 0 4px 12px rgba(201,81,42,0.3); }
  .search-btn:disabled { background: #c4a898; transform: none; box-shadow: none; cursor: not-allowed; }

  /* Loading */
  .loading { text-align: center; padding: 50px 0; display: none; }
  .loading.active { display: block; }

  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--smoke);
    border-top-color: var(--terracotta);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
    margin: 0 auto 14px;
  }

  @keyframes spin { to { transform: rotate(360deg); } }

  .loading-text { font-family: 'DM Mono', monospace; font-size: 12px; color: #8a7060; letter-spacing: 0.1em; }

  .loading-steps { margin-top: 12px; display: flex; flex-direction: column; gap: 4px; align-items: center; }

  .loading-step {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: #c4a898;
    letter-spacing: 0.08em;
    transition: color 0.3s;
  }

  .loading-step.active { color: var(--terracotta); }
  .loading-step.done { color: var(--accent); }

  /* Source Tabs */
  .source-tabs { display: flex; gap: 8px; margin-bottom: 20px; flex-wrap: wrap; }

  .source-tab {
    padding: 6px 14px;
    border: 1.5px solid var(--smoke);
    border-radius: 2px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    cursor: pointer;
    background: none;
    color: #8a7060;
    transition: all 0.15s;
  }

  .source-tab:hover { border-color: var(--terracotta); color: var(--terracotta); }
  .source-tab.active { background: var(--ink); border-color: var(--ink); color: white; }

  /* Results */
  .results { display: none; }
  .results.active { display: block; }

  .results-header {
    display: flex;
    justify-content: space-between;
    align-items: baseline;
    margin-bottom: 20px;
    flex-wrap: wrap;
    gap: 8px;
  }

  .results-title { font-family: 'Playfair Display', serif; font-size: 26px; }
  .results-count { font-family: 'DM Mono', monospace; font-size: 11px; color: var(--terracotta); letter-spacing: 0.1em; }

  /* Card */
  .card {
    background: var(--cream);
    border: 1px solid var(--smoke);
    border-radius: 2px;
    padding: 24px 28px;
    margin-bottom: 14px;
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 16px;
    transition: all 0.2s;
    position: relative;
    overflow: hidden;
    animation: fadeInUp 0.3s ease both;
  }

  .card::before {
    content: '';
    position: absolute;
    left: 0; top: 0; bottom: 0;
    width: 4px;
    transform: scaleY(0);
    transition: transform 0.2s;
  }

  .card.source-places::before { background: var(--places-blue); }
  .card.source-ai::before { background: var(--terracotta); }

  .card:hover { box-shadow: 4px 4px 0 rgba(201,81,42,0.12); transform: translateX(-2px); }
  .card:hover::before { transform: scaleY(1); }

  .card-name { font-family: 'Playfair Display', serif; font-size: 20px; margin-bottom: 4px; color: var(--ink); }
  .card-address { font-size: 13px; color: #8a7060; margin-bottom: 8px; font-weight: 300; }
  .card-desc { font-size: 13px; line-height: 1.65; color: #4a3828; }

  .card-meta { display: flex; align-items: center; gap: 12px; margin-top: 10px; flex-wrap: wrap; }

  .rating { display: flex; align-items: center; gap: 4px; font-family: 'DM Mono', monospace; font-size: 12px; color: var(--ink); }
  .stars { color: var(--gold); font-size: 11px; }
  .review-count { color: #8a7060; font-size: 11px; }

  .open-badge {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    padding: 3px 8px;
    border-radius: 2px;
  }

  .open-badge.open { background: rgba(42,107,92,0.12); color: var(--accent); }
  .open-badge.closed { background: rgba(201,81,42,0.1); color: var(--terracotta); }

  .price-level { font-family: 'DM Mono', monospace; font-size: 12px; color: #8a7060; }

  .card-tags { display: flex; gap: 6px; flex-wrap: wrap; margin-top: 10px; }

  .tag {
    padding: 3px 9px;
    border-radius: 2px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
  }

  .tag.red { background: rgba(201,81,42,0.1); color: var(--terracotta); }
  .tag.green { background: rgba(42,107,92,0.1); color: var(--accent); }

  .source-badge {
    font-family: 'DM Mono', monospace;
    font-size: 9px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    padding: 2px 7px;
    border-radius: 2px;
    border: 1px solid;
  }

  .source-badge.places { color: var(--places-blue); border-color: rgba(26,115,232,0.3); background: rgba(26,115,232,0.06); }
  .source-badge.ai { color: var(--terracotta); border-color: rgba(201,81,42,0.3); background: rgba(201,81,42,0.06); }

  .card-right {
    display: flex;
    flex-direction: column;
    align-items: flex-end;
    gap: 8px;
    min-width: 80px;
  }

  .card-area {
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
    color: #8a7060;
    text-align: right;
  }

  .maps-link {
    padding: 7px 13px;
    border: 1.5px solid var(--terracotta);
    color: var(--terracotta);
    text-decoration: none;
    border-radius: 2px;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    letter-spacing: 0.08em;
    text-transform: uppercase;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .maps-link:hover { background: var(--terracotta); color: white; }

  /* Error */
  .error { display: none; background: #fff3f0; border: 1px solid #f0c0b0; border-radius: 2px; padding: 18px 22px; color: #a03020; font-size: 13px; line-height: 1.6; margin-bottom: 16px; }
  .error.active { display: block; }

  /* Note */
  .note {
    text-align: center;
    font-family: 'DM Mono', monospace;
    font-size: 10px;
    color: #b09a88;
    letter-spacing: 0.08em;
    padding: 28px 0 56px;
    line-height: 1.8;
  }

  @keyframes fadeInUp {
    from { opacity: 0; transform: translateY(8px); }
    to { opacity: 1; transform: translateY(0); }
  }

  @media (max-width: 600px) {
    .card { grid-template-columns: 1fr; }
    .card-right { align-items: flex-start; flex-direction: row; flex-wrap: wrap; }
  }
</style>
</head>
<body>
<div class="container">

  <header>
    <p class="eyebrow">ðŸ«“ Turkish Street Food Finder</p>
    <h1>Find <em>GÃ¶zleme</em><br>Near You</h1>
    <p class="subtitle">Live results from Google Places combined with AI knowledge â€” the most complete GÃ¶zleme guide in London.</p>
  </header>

  <div class="divider"><span>âœ¦</span></div>

  <!-- API Key Panel -->
  <div class="api-panel" id="apiPanel">
    <button class="api-panel-toggle" id="apiToggle" onclick="toggleApiPanel()">
      <span>&#9881; API Keys &amp; Data Sources</span>
      <span class="chevron">&#9660;</span>
    </button>
    <div class="api-panel-body" id="apiBody">
      <div class="api-grid" style="grid-template-columns: 1fr;">
        <div class="api-field">
          <label>Anthropic API Key</label>
          <input type="password" id="anthropicKey" placeholder="sk-ant-..." oninput="saveKeys()" autocomplete="off">
          <p class="api-hint">Powers AI descriptions &amp; gap-filling.<br>Get one at <a href="https://console.anthropic.com" target="_blank">console.anthropic.com</a></p>
        </div>
      </div>
      <p class="api-hint" style="margin-top:14px; padding: 10px 12px; background: rgba(42,107,92,0.07); border-left: 3px solid var(--accent);">
        Google Places key is configured in <strong>.env</strong> on the server &mdash; no browser exposure needed.
      </p>
      <div class="api-status" id="apiStatus">
        <span class="status-pill" id="pillAnthropic"><span class="dot"></span>Claude: not set</span>
        <span class="status-pill active"><span class="dot"></span>Google Places: via server</span>
      </div>
    </div>
  </div>

  <!-- Search -->
  <div class="search-section">
    <label class="search-label">Search Location</label>
    <div class="search-row">
      <input type="text" class="search-input" id="locationInput" placeholder="e.g. Hackney, Stoke Newington, Northeast London..." value="Northeast London">
      <button class="search-btn" id="searchBtn" onclick="searchGozleme()">Search</button>
    </div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loading">
    <div class="spinner"></div>
    <p class="loading-text">Searching for Gozleme spots...</p>
    <div class="loading-steps">
      <span class="loading-step" id="step1">1. Querying Google Places...</span>
      <span class="loading-step" id="step2">2. Asking Claude AI...</span>
      <span class="loading-step" id="step3">3. Merging &amp; deduplicating results...</span>
    </div>
  </div>

  <!-- Error -->
  <div class="error" id="error"></div>

  <!-- Results -->
  <div class="results" id="results">
    <div class="results-header">
      <h2 class="results-title">Spots Found</h2>
      <span class="results-count" id="resultsCount"></span>
    </div>
    <div class="source-tabs" id="sourceTabs">
      <button class="source-tab active" data-filter="all" onclick="filterCards(this)">All</button>
      <button class="source-tab" data-filter="places" onclick="filterCards(this)">Google Places</button>
      <button class="source-tab" data-filter="ai" onclick="filterCards(this)">AI Only</button>
    </div>
    <div id="cardContainer"></div>
  </div>

  <p class="note">
    Google Places results reflect live business data &middot; AI results are from Claude's training knowledge<br>
    Always call ahead to confirm Gozleme is currently on the menu
  </p>

</div>

<script>
// â”€â”€ Key storage (sessionStorage only â€” not persisted to disk) â”€â”€
function saveKeys() {
  const ak = document.getElementById('anthropicKey').value.trim();
  if (ak) sessionStorage.setItem('anthropic_key', ak);
  updateStatusPills();
}

function loadKeys() {
  const ak = sessionStorage.getItem('anthropic_key') || '';
  if (ak) document.getElementById('anthropicKey').value = ak;
  updateStatusPills();
}

function updateStatusPills() {
  const ak = document.getElementById('anthropicKey').value.trim();
  const pa = document.getElementById('pillAnthropic');
  if (ak) { pa.className = 'status-pill active'; pa.innerHTML = '<span class="dot"></span>Claude: ready'; }
  else     { pa.className = 'status-pill';        pa.innerHTML = '<span class="dot"></span>Claude: not set'; }
}

function toggleApiPanel() {
  const body = document.getElementById('apiBody');
  const toggle = document.getElementById('apiToggle');
  body.classList.toggle('open');
  toggle.classList.toggle('open');
}

// â”€â”€ Filter tabs â”€â”€
function filterCards(btn) {
  document.querySelectorAll('.source-tab').forEach(t => t.classList.remove('active'));
  btn.classList.add('active');
  const filter = btn.dataset.filter;
  document.querySelectorAll('.card').forEach(card => {
    const src = card.dataset.source;
    if (filter === 'all') { card.style.display = ''; }
    else if (filter === 'places' && src === 'places') { card.style.display = ''; }
    else if (filter === 'ai' && src === 'ai') { card.style.display = ''; }
    else { card.style.display = 'none'; }
  });
}

// â”€â”€ Google Places â€” calls local Express proxy (avoids CORS) â”€â”€
async function fetchGooglePlaces(query) {
  const resp = await fetch('/api/places', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({
      textQuery: query,
      latitude: 51.5200,
      longitude: -0.0700,
      radius: 15000,
      maxResults: 20
    })
  });

  const data = await resp.json();
  if (!resp.ok) throw new Error(data.error || 'Google Places proxy error');

  return (data.places || []).map(function(p) {
    return {
      name: (p.displayName && p.displayName.text) ? p.displayName.text : 'Unknown',
      address: p.formattedAddress || p.shortFormattedAddress || '',
      area: extractArea(p.formattedAddress || ''),
      rating: p.rating || null,
      reviewCount: p.userRatingCount || null,
      isOpen: (p.currentOpeningHours && p.currentOpeningHours.openNow != null) ? p.currentOpeningHours.openNow : null,
      priceLevel: p.priceLevel || null,
      mapsUrl: p.googleMapsUri || null,
      source: 'places',
      description: '',
      tags: []
    };
  });
}

function extractArea(address) {
  var parts = address.split(',').map(function(s) { return s.trim(); });
  if (parts.length >= 3) return parts[parts.length - 3] || parts[1] || '';
  return parts[1] || '';
}

function priceLevelLabel(level) {
  var map = {
    'PRICE_LEVEL_FREE': 'Free',
    'PRICE_LEVEL_INEXPENSIVE': 'GBP',
    'PRICE_LEVEL_MODERATE': 'GBP GBP',
    'PRICE_LEVEL_EXPENSIVE': 'GBP GBP GBP',
    'PRICE_LEVEL_VERY_EXPENSIVE': 'GBP GBP GBP GBP'
  };
  var labels = { 'PRICE_LEVEL_FREE': 'Free', 'PRICE_LEVEL_INEXPENSIVE': '\u00a3', 'PRICE_LEVEL_MODERATE': '\u00a3\u00a3', 'PRICE_LEVEL_EXPENSIVE': '\u00a3\u00a3\u00a3', 'PRICE_LEVEL_VERY_EXPENSIVE': '\u00a3\u00a3\u00a3\u00a3' };
  return labels[level] || null;
}

function starString(rating) {
  if (!rating) return '';
  var full = Math.floor(rating);
  var half = (rating - full) >= 0.4 ? 1 : 0;
  var empty = 5 - full - half;
  return '\u2605'.repeat(full) + (half ? '\u00bd' : '') + '\u2606'.repeat(empty);
}

// â”€â”€ Claude AI Fetch â”€â”€
async function fetchClaudeResults(location, anthropicKey, knownNames) {
  var exclusion = knownNames.length > 0
    ? '\n\nDo NOT include these places (already found via Google): ' + knownNames.join(', ')
    : '';

  var prompt = 'You are a helpful local food guide for London. Find real eateries, restaurants, cafes, or market stalls in or near "' + location + '" (London, UK) that are known to serve Gozleme (Turkish stuffed flatbread).' + exclusion + '\n\nIMPORTANT: Use only plain ASCII characters in all string values. Replace apostrophes with a plain single quote or omit them.\n\nReturn ONLY a valid JSON array, no markdown fences, no explanation. Format:\n[{"name":"...","area":"...","address":"...","description":"one or two plain sentences","tags":["tag1","tag2"]}]\n\nInclude up to 12 results. Only include real places you are confident about. If fewer than 4 exist in that exact area, expand to nearby London areas.';

  var resp = await fetch('https://api.anthropic.com/v1/messages', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-api-key': anthropicKey,
      'anthropic-version': '2023-06-01',
      'anthropic-dangerous-direct-browser-access': 'true'
    },
    body: JSON.stringify({
      model: 'claude-sonnet-4-20250514',
      max_tokens: 2000,
      messages: [{ role: 'user', content: prompt }]
    })
  });

  var data = await resp.json();
  if (!resp.ok) throw new Error('Claude: ' + ((data.error && data.error.message) ? data.error.message : resp.statusText));

  var allText = (data.content || []).filter(function(b) { return b.type === 'text'; }).map(function(b) { return b.text; }).join('');
  if (!allText) throw new Error('No text response from Claude');

  var jsonText = allText.replace(/```json\s*/gi, '').replace(/```\s*/g, '').trim();
  var arrayMatch = jsonText.match(/\[[\s\S]*\]/);
  if (!arrayMatch) throw new Error('Could not parse Claude response as JSON array');

  jsonText = arrayMatch[0]
    .replace(/[\u2018\u2019]/g, "'")
    .replace(/[\u201C\u201D]/g, '"')
    .replace(/[\u2013\u2014]/g, '-');

  var places;
  try {
    places = JSON.parse(jsonText);
  } catch(e) {
    var sanitised = jsonText.replace(/"([^"]*)"/g, function(_, inner) {
      return '"' + inner.replace(/[^\x20-\x7E]/g, '') + '"';
    });
    places = JSON.parse(sanitised);
  }

  return places.map(function(p) {
    return Object.assign({ rating: null, reviewCount: null, isOpen: null, priceLevel: null, mapsUrl: null, source: 'ai' }, p);
  });
}

// â”€â”€ Deduplication â”€â”€
function normaliseName(name) {
  return name.toLowerCase().replace(/[^a-z0-9]/g, '');
}

function dedupe(placesResults, aiResults) {
  var merged = placesResults.slice();
  var seen = new Set(placesResults.map(function(p) { return normaliseName(p.name); }));

  aiResults.forEach(function(place) {
    var norm = normaliseName(place.name);
    var isDupe = false;
    seen.forEach(function(s) {
      if (s === norm || s.includes(norm) || norm.includes(s)) isDupe = true;
    });
    if (!isDupe) {
      merged.push(place);
      seen.add(norm);
    }
  });

  return merged;
}

// â”€â”€ Step indicators â”€â”€
function setStep(n) {
  for (var i = 1; i <= 3; i++) {
    var el = document.getElementById('step' + i);
    if (i < n) el.className = 'loading-step done';
    else if (i === n) el.className = 'loading-step active';
    else el.className = 'loading-step';
  }
}

// â”€â”€ Main search â”€â”€
async function searchGozleme() {
  var location = document.getElementById('locationInput').value.trim() || 'Northeast London';
  var anthropicKey = document.getElementById('anthropicKey').value.trim();

  if (!anthropicKey) {
    document.getElementById('apiBody').classList.add('open');
    document.getElementById('apiToggle').classList.add('open');
    showError('Please enter your Anthropic API key above to search.');
    return;
  }

  var btn = document.getElementById('searchBtn');
  var loading = document.getElementById('loading');
  var results = document.getElementById('results');
  var error = document.getElementById('error');
  var cardContainer = document.getElementById('cardContainer');
  var resultsCount = document.getElementById('resultsCount');

  btn.disabled = true;
  loading.classList.add('active');
  results.classList.remove('active');
  error.classList.remove('active');
  cardContainer.innerHTML = '';
  setStep(1);

  var placesResults = [];
  var aiResults = [];
  var errors = [];

  // Step 1: Google Places (via server proxy â€” no key needed client-side)
  try {
    setStep(1);
    placesResults = await fetchGooglePlaces('gozleme ' + location + ' London');
  } catch(e) {
    errors.push(e.message);
  }

  // Step 2: Claude AI
  try {
    setStep(2);
    var knownNames = placesResults.map(function(p) { return p.name; });
    aiResults = await fetchClaudeResults(location, anthropicKey, knownNames);
  } catch(e) {
    errors.push(e.message);
  }

  // Step 3: Merge
  setStep(3);
  await new Promise(function(r) { setTimeout(r, 300); });

  var allPlaces = dedupe(placesResults, aiResults);

  loading.classList.remove('active');
  btn.disabled = false;

  if (allPlaces.length === 0) {
    showError(errors.length
      ? 'Could not retrieve results. ' + errors.join(' | ')
      : 'No Gozleme spots found near "' + location + '". Try a broader area like "East London" or "London".'
    );
    return;
  }

  if (errors.length) {
    error.classList.add('active');
    error.textContent = 'Partial results only: ' + errors.join(' | ');
  }

  // Sort: Places (with ratings) first, then by rating desc
  allPlaces.sort(function(a, b) {
    if (a.source === 'places' && b.source !== 'places') return -1;
    if (b.source === 'places' && a.source !== 'places') return 1;
    if (a.rating && b.rating) return b.rating - a.rating;
    return 0;
  });

  results.classList.add('active');

  var placesCount = allPlaces.filter(function(p) { return p.source === 'places'; }).length;
  var aiCount = allPlaces.filter(function(p) { return p.source === 'ai'; }).length;
  var parts = [];
  if (placesCount) parts.push(placesCount + ' from Google');
  if (aiCount) parts.push(aiCount + ' from AI');
  resultsCount.textContent = allPlaces.length + ' spot' + (allPlaces.length !== 1 ? 's' : '') + ' \u00b7 ' + parts.join(', ');

  allPlaces.forEach(function(place, i) {
    var card = document.createElement('div');
    card.className = 'card source-' + place.source;
    card.dataset.source = place.source;
    card.style.animationDelay = (i * 0.05) + 's';

    var mapsUrl = place.mapsUrl ||
      'https://www.google.com/maps/search/' + encodeURIComponent((place.name || '') + ' ' + (place.address || '') + ' London');

    var metaHtml = '';
    if (place.rating) {
      metaHtml += '<span class="rating"><span class="stars">' + starString(place.rating) + '</span> ' + place.rating.toFixed(1);
      if (place.reviewCount) metaHtml += ' <span class="review-count">(' + place.reviewCount.toLocaleString() + ')</span>';
      metaHtml += '</span>';
    }
    if (place.isOpen === true)  metaHtml += '<span class="open-badge open">Open now</span>';
    if (place.isOpen === false) metaHtml += '<span class="open-badge closed">Closed</span>';
    var priceLabel = priceLevelLabel(place.priceLevel);
    if (priceLabel) metaHtml += '<span class="price-level">' + priceLabel + '</span>';

    var sourceBadge = place.source === 'places'
      ? '<span class="source-badge places">Google Places</span>'
      : '<span class="source-badge ai">Claude AI</span>';

    var tags = (place.tags || []).map(function(t, idx) {
      return '<span class="tag ' + (idx % 2 === 0 ? 'red' : 'green') + '">' + escHtml(t) + '</span>';
    }).join('');

    card.innerHTML =
      '<div class="card-left">' +
        '<h3 class="card-name">' + escHtml(place.name || 'Unknown') + '</h3>' +
        '<p class="card-address">&#128205; ' + escHtml(place.address || place.area || 'London') + '</p>' +
        (place.description ? '<p class="card-desc">' + escHtml(place.description) + '</p>' : '') +
        (metaHtml ? '<div class="card-meta">' + metaHtml + '</div>' : '') +
        '<div class="card-tags">' + sourceBadge + tags + '</div>' +
      '</div>' +
      '<div class="card-right">' +
        '<span class="card-area">' + escHtml(place.area || '') + '</span>' +
        '<a href="' + mapsUrl + '" target="_blank" rel="noopener" class="maps-link">Map &#8594;</a>' +
      '</div>';

    cardContainer.appendChild(card);
  });
}

function showError(msg) {
  var error = document.getElementById('error');
  error.classList.add('active');
  error.textContent = msg;
  document.getElementById('loading').classList.remove('active');
  document.getElementById('searchBtn').disabled = false;
}

function escHtml(str) {
  var d = document.createElement('div');
  d.textContent = String(str);
  return d.innerHTML;
}

// â”€â”€ Init â”€â”€
document.getElementById('locationInput').addEventListener('keydown', function(e) {
  if (e.key === 'Enter') searchGozleme();
});

loadKeys();

// Auto-open API panel if no Anthropic key saved yet
if (!sessionStorage.getItem('anthropic_key')) {
  document.getElementById('apiBody').classList.add('open');
  document.getElementById('apiToggle').classList.add('open');
}
</script>
</body>
</html>
